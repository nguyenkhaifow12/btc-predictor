<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Dá»± Ä‘oÃ¡n xu hÆ°á»›ng BTC</title>
  <script src="https://cdn.jsdelivr.net/npm/technicalindicators@3.1.0/dist/browser.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    button { padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    #result { margin-top: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    ul { padding-left: 20px; }
  </style>
</head>
<body>
  <h2>ğŸ” Dá»± Ä‘oÃ¡n xu hÆ°á»›ng BTC vá»›i Äa chá»‰ bÃ¡o</h2>
  <button onclick="startAnalysis()">PhÃ¢n tÃ­ch ngay</button>
  <div id="result"></div>

  <script>
    async function startAnalysis() {
      const waitForTechnicalIndicators = () => new Promise((resolve, reject) => {
        let attempts = 0;
        const interval = setInterval(() => {
          if (window.technicalindicators && window.technicalindicators.EMA) {
            clearInterval(interval);
            resolve();
          } else if (++attempts > 10) {
            clearInterval(interval);
            reject(new Error("technicalindicators chÆ°a sáºµn sÃ ng"));
          }
        }, 200);
      });

      try {
        await waitForTechnicalIndicators();

        const { EMA, MACD, RSI, ADX } = window.technicalindicators;

        const [priceRes, fundingRes, oiRes] = await Promise.all([
          fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT'),
          fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=1'),
          fetch('https://fapi.binance.com/fapi/v1/openInterest?symbol=BTCUSDT')
        ]);

        const price = parseFloat((await priceRes.json()).price);
        const fundingRate = parseFloat((await fundingRes.json())[0].fundingRate);
        const openInterest = parseFloat((await oiRes.json()).openInterest);

        // Giáº£ láº­p dá»¯ liá»‡u giÃ¡ Ä‘Ã³ng cá»­a
        const closePrices = Array.from({ length: 200 }, () => price * (1 + (Math.random() - 0.5) * 0.02));

        const ema20 = EMA.calculate({ period: 20, values: closePrices });
        const ema50 = EMA.calculate({ period: 50, values: closePrices });
        const ema200 = EMA.calculate({ period: 200, values: closePrices });

        const macd = MACD.calculate({
          values: closePrices,
          fastPeriod: 12,
          slowPeriod: 26,
          signalPeriod: 9,
          SimpleMAOscillator: false,
          SimpleMASignal: false
        });

        const rsi = RSI.calculate({ period: 14, values: closePrices });

        const adx = ADX.calculate({
          close: closePrices,
          high: closePrices.map(p => p * 1.01),
          low: closePrices.map(p => p * 0.99),
          period: 14
        });

        const ema20Val = ema20.at(-1);
        const ema50Val = ema50.at(-1);
        const ema200Val = ema200.at(-1);
        const macdVal = macd.at(-1)?.MACD;
        const macdSignal = macd.at(-1)?.signal;
        const rsiVal = rsi.at(-1);
        const adxVal = adx.at(-1)?.adx;
        const plusDI = adx.at(-1)?.pdi;
        const minusDI = adx.at(-1)?.mdi;

        // Dá»¯ liá»‡u phá»¥ (mock)
        const volume = 1200, avgVolume = 1000, oiVolume = 1500, outflow = 1100;
        const candle = "bullish";

        let signals = [];

        if (ema20Val > ema50Val && ema50Val > ema200Val) signals.push("âœ… EMA20 > EMA50 > EMA200");
        if (macdVal > macdSignal) signals.push("âœ… MACD > Signal");
        if (rsiVal > 55 && rsiVal < 70) signals.push("âœ… RSI > 55 vÃ  < 70");
        if (adxVal > 25 && plusDI > minusDI) signals.push("âœ… ADX > 25 vÃ  +DI > -DI");
        if (volume > avgVolume) signals.push("âœ… Volume cao hÆ¡n trung bÃ¬nh");
        if (fundingRate < 0) signals.push("âœ… Funding Rate < 0 â†’ dá»… Ä‘áº£o chiá»u tÄƒng");
        if (openInterest > 0 && oiVolume > avgVolume) signals.push("âœ… OI vÃ  Volume tÄƒng máº¡nh â†’ xÃ¡c nháº­n trend");
        if (outflow > 1000) signals.push("âœ… BTC rÃºt khá»i sÃ n nhiá»u â†’ tÃ­n hiá»‡u tÃ­ch trá»¯");
        if (candle === "bullish") signals.push("âœ… MÃ´ hÃ¬nh náº¿n tÄƒng gáº§n Ä‘Ã¢y");

        const finalSignal =
          signals.length >= 6 ? "ğŸ“ˆ TÃ­n hiá»‡u máº¡nh: CÃ³ thá»ƒ mua thá»­ vá»›i vá»‹ tháº¿ nhá»" :
          signals.length >= 3 ? "ğŸ“Š TÃ­n hiá»‡u trung láº­p: Theo dÃµi thÃªm" :
          "âš ï¸ TÃ­n hiá»‡u yáº¿u hoáº·c khÃ´ng rÃµ rÃ ng: Chá» thÃªm";

        document.getElementById('result').innerHTML =
          `<h3>Káº¿t quáº£:</h3><ul><li>${signals.join('</li><li>')}</li></ul><p><strong>${finalSignal}</strong></p>`;

      } catch (error) {
        document.getElementById('result').innerHTML = `<p style="color:red">âŒ Lá»—i: ${error.message}</p>`;
        console.error(error);
      }
    }
  </script>
</body>
</html>
